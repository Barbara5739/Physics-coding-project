from __future__ import annotations
import matplotlib.pyplot as plt
from matplotlib import animation
import numpy as np
import math as math
import pandas as pd
from abc import ABC, abstractmethod 
from galaxy_V2 import Star, Object_manager, Planet_physical_orbit, alien_visitor #, moon
from pathlib import Path
import sys

#  Initialization of some constants:
#Sun initial
Ms = 2.0e30   # mass of sun in kg unit
sx=0
sy=0
day= 24*3600
scale = 5e11   #scale for the plot"

#  Initialize "working dicts"
stars = {}
moving_objects= {}
points = {}
lines = {}

def load_data():
    # get planets, aliens, moons
    workdir = Path(__file__).resolve().parent
    file_path = workdir / "data" / "galaxy_objects.csv"

    galaxy_objects = pd.read_csv(file_path,  sep=";")

    for index, row in galaxy_objects.iterrows():
        orbit_star_name = row["orbiting_star"]  
        try:                                        # checks if the refrence star ( sun ) object exists
            orbit_star = stars[orbit_star_name]     #
        except:
            sys.exit(f"The orbiting star {orbit_star_name} does not exist") 
        match row["type"]:              # creates objects based on type set in the input file
            case "PhysicsPlanet":
                Mobject = Object_manager.create_planet_physical_orbit(row["name"], 
                                                            orbit_star, 
                                                            float(row["mass"]), 
                                                            float(row["start_x_position"]),
                                                            float(row["start_y_position"]),
                                                            float(row["start_x_speed"]),
                                                            float(row["start_y_speed"])) 
            case "CircularPlanet":
                    Mobject =  Object_manager.create_planet_circular_orbit(row["name"], 
                                                                orbit_star, 
                                                                float(row["mass"]), 
                                                                float(row["start_x_position"]),
                                                                float(row["start_y_position"]))
            case "AlienVisitor":
                    Mobject =  Object_manager.create_alien_visitor(row["name"], 
                                                                orbit_star, 
                                                                float(row["mass"]), 
                                                                float(row["start_x_position"]),
                                                                float(row["start_y_position"]),
                                                                float(row["perihelion_distance"]),
                                                                float(row["orbital_eccentricity"])
                                                                ) 
            # case "Moon":
                    # Mobject = Object_manager.create_moon(row["name"], 
                    #                                      orbit_star, 
                    #                                      float(row["mass"]), 
                    #                                      float(row["start_x_position"]),
                    #                                      float(row["start_y_position"]),
                    #                                      float(row["start_x_speed"]),
                    #                                      float(row["start_y_speed"]))
                                                               
        moving_objects[row["name"]] = Mobject # saves the created object to the collection ( dictionary ) 


def init():
    print("init")
    if not points: # check if there are not points already created
        for key, s in stars.items(): # plotting points for star ( sun )
            point, = ax.plot([], [], 'y*', label=s.name, markersize=20)
            points[key] = point

        for key, o in moving_objects.items(): # plotting points for objects ( planets, moons, aliens )
            if type(o) is alien_visitor:
                marker = 'rv'
                markersize = 15
            elif type(o) is  Planet_physical_orbit:
                marker = 'o'
                markersize = 9
            # elif type(o) is moon:
            #     marker = '.'
            #     markersize = 5
            line, = ax.plot([], [], lw=1, color='green')
            lines[key]= line
            point, = ax.plot([], [], marker, label=o.name, markersize = markersize )
            points[key] = point
    ax.legend()  #  legenda only shows labels if they exist
    return points


#Animation
def animate(i):
    print(i) # checking if animate is done
    
    for key, S in stars.items(): # loops over al stars
        x, y  = S.get_location( ) # gets the location of the star according to the galaxy simulator
        points[key].set_data([x],[y]) # sets the plot point for the stars
    for key, O in moving_objects.items():
        x, y  = O.get_location(time_interval=day) # gets the location of the moving objects according to the galaxy simulator
        points[key].set_data([x],[y]) # sets the plot point for the moving objects
        lines[key].set_data(O.get_loclist()) # draw the line for the moving objects
        
    #######  old code

    # dt = day  # seconds per step
    # planet.get_location(dt)
    # planet2.get_location(dt)
    # # Animation for planet 
    # line_p.set_data(planet.x_positions, planet.y_positions)
    # xp_new, yp_new = planet.x_positions[-1], planet.y_positions[-1]
    # point_p.set_data([xp_new], [yp_new])
    # text_p.set_position((xp_new, yp_new))
    # #Animation for mars
    # line_p2.set_data(planet2.x_positions, planet2.y_positions)
    # xm_new, ym_new = planet2.x_positions[-1], planet2.y_positions[-1]
    # point_p2.set_data([xm_new], [ym_new])
    # text_p2.set_position((xm_new, ym_new))
    # #Animation for alien
    # xa_new, ya_new = alien.x_positions[i], alien.y_positions[i]
    # line_a.set_data(alien.x_positions[:i+1], alien.y_positions[:i+1])
    # point_a.set_data([xa_new], [ya_new])
    # text_a.set_position((xa_new, ya_new))
    # return line_p, point_p, point_s, text_p, text_s, point_a, text_a, line_p2, point_p2, text_p2




########################## Main program #################################
#Seting up the objects(This part has to be read from another file?)
sun = Star("Sun", Ms, sx, sy)
stars["Sun"]= sun
#  load planets etc
load_data()

###visualization of the planet movement
###Creates the Solar System
fig, ax = plt.subplots(figsize=(10,10))    
ax.set_aspect('equal')
ax.grid()
ax.axis('equal')
ax.set_xlim(-scale, scale)
ax.set_ylim(-scale, scale)

plt.xlabel("X")
plt.ylabel("Y")
plt.title("Solar System")

# start the animation
anim = animation.FuncAnimation(fig, animate, init_func=init,frames=400, interval=1, blit=False)
plt.show() # shows the galaxy system


